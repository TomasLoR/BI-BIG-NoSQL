input {
  file {
    path => "/usr/share/logstash/data/pesticide_sales.csv"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    tags => ["pesticide_sales"]
  }
}

filter {
  if "pesticide_sales" in [tags] {
    csv {
      separator => ","
      skip_header => true
      columns => ["freq", "unit", "pesticid", "geo", "TIME_PERIOD", "OBS_VALUE"]
    }

    mutate {
      convert => {
        "OBS_VALUE" => "float"
        "TIME_PERIOD" => "integer"
      }
      
      # Add month and day to create a complete date string
      add_field => { "date_string" => "%{TIME_PERIOD}-01-01" }
    }

    # Parse the formatted date string
    date {
      match => [ "date_string", "yyyy-MM-dd" ]
      target => "@timestamp"
      tag_on_failure => ["date_parse_failure"]
      remove_field => ["date_string"]
    }
  }
}

output {
  if "pesticide_sales" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "pesticide_sales"
      template => "/usr/share/logstash/template/pesticide_sales.json"
      template_name => "pesticide_sales"
      template_overwrite => true
    }
  }
}